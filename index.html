<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="google-site-verification" content="vGS8JFJQVv-de5om2knEDYC0ui0VSojWG5fVZZFj30o" />
    <meta name="naver-site-verification" content="48957fb2a7409eca13cd790b2c03ce90cce6c1af" />
    <title>ì¹´ê³µë§µ | ì‘ì—…í•˜ê¸° ì¢‹ì€ ì¹´í˜ ì°¾ê¸° (ì½˜ì„¼íŠ¸/ì™€ì´íŒŒì´)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="ë„¤ì´ë²„ ë¸”ë¡œê·¸ ë¦¬ë·° ë¶„ì„ìœ¼ë¡œ ì°¾ëŠ” ì¹´ê³µ ìµœì  ì¹´í˜. ì½˜ì„¼íŠ¸, ì™€ì´íŒŒì´, ì†ŒìŒ ë ˆë²¨, ì‘ì—… ì í•©ë„ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.">
    <meta name="keywords" content="ì¹´ê³µ, ì¹´í˜ ê³µë¶€, ë…¸íŠ¸ë¶ ì¹´í˜, ì½˜ì„¼íŠ¸ ë§ì€ ì¹´í˜, ì¡°ìš©í•œ ì¹´í˜, ì‘ì—…í•˜ê¸° ì¢‹ì€ ì¹´í˜, ìŠ¤í„°ë”” ì¹´í˜">
    <meta name="theme-color" content="#4CAF50">
    <link rel="canonical" href="https://cagongmap.vercel.app">
    
    <!-- OG Tags -->
    <meta property="og:title" content="ì¹´ê³µë§µ | ì‘ì—…í•˜ê¸° ì¢‹ì€ ì¹´í˜ ì°¾ê¸°">
    <meta property="og:description" content="ë„¤ì´ë²„ ë¸”ë¡œê·¸ ë¦¬ë·° ë¶„ì„ìœ¼ë¡œ ì°¾ëŠ” ì¹´ê³µ ìµœì  ì¹´í˜. ì½˜ì„¼íŠ¸, ì™€ì´íŒŒì´, ì†ŒìŒ ë ˆë²¨ í™•ì¸">
    <meta property="og:image" content="https://cagongmap.vercel.app/cagong1.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="https://cagongmap.vercel.app">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ko_KR">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ì¹´ê³µë§µ | ì‘ì—…í•˜ê¸° ì¢‹ì€ ì¹´í˜ ì°¾ê¸°">
    <meta name="twitter:description" content="ë„¤ì´ë²„ ë¸”ë¡œê·¸ ë¦¬ë·° ë¶„ì„ìœ¼ë¡œ ì°¾ëŠ” ì¹´ê³µ ìµœì  ì¹´í˜">
    <meta name="twitter:image" content="https://cagongmap.vercel.app/cagong1.png">
    
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ì¹´ê³µë§µ">
    
    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "ì¹´ê³µë§µ",
      "url": "https://cagongmap.vercel.app",
      "description": "ë„¤ì´ë²„ ë¸”ë¡œê·¸ ë¦¬ë·° ë¶„ì„ ê¸°ë°˜ ì¹´ê³µ ìµœì í™” ì¹´í˜ ê²€ìƒ‰ ì„œë¹„ìŠ¤",
      "applicationCategory": "LifestyleApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "KRW"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.5",
        "ratingCount": "100"
      }
    }
    </script>
    
    <!-- Vercel Analytics -->
    <script>
      window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="https://cdn.vercel-insights.com/v1/script.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            font-family: sans-serif;
        }
        
        /* ë¡œë”© í™”ë©´ */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out;
        }
        
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        #loading-screen img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #map { 
            width: 100%; 
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
        }
        
        /* êµ¬ê¸€ë§µ ìŠ¤íƒ€ì¼ ê²€ìƒ‰ë°” */
        .search-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: calc(100% - 40px);
            max-width: 600px;
        }
        
        .search-bar {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            padding: 12px 16px;
            gap: 12px;
        }
        
        .search-bar input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
        }
        
        .search-bar .close-btn {
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 20px;
            color: #666;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 380px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            z-index: 999;
            overflow: hidden;
            transition: transform 0.3s ease;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
        }
        
        /* ëª¨ë°”ì¼: êµ¬ê¸€ë§µ ìŠ¤íƒ€ì¼ í•˜ë‹¨ ì‹œíŠ¸ */
        @media (max-width: 768px) {
            .search-container {
                top: 10px;
                width: calc(100% - 20px);
            }
            
            .sidebar {
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: auto;
                max-height: 80%;
                border-radius: 16px 16px 0 0;
                box-shadow: 0 -2px 16px rgba(0,0,0,0.2);
                transform: translateY(calc(100% - 80px));
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .sidebar.collapsed {
                transform: translateY(calc(100% - 80px));
            }
            
            .sidebar.expanded {
                transform: translateY(0);
            }
            
            .sidebar-drag-handle {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 8px 0;
                cursor: grab;
                touch-action: none;
                position: sticky;
                top: 0;
                background: white;
                z-index: 100;
                border-radius: 16px 16px 0 0;
            }
            
            .sidebar-drag-handle::before {
                content: '';
                width: 40px;
                height: 4px;
                background: #dadce0;
                border-radius: 2px;
            }
        }
        
        .sidebar-drag-handle {
            display: none;
            flex-shrink: 0;
        }
        
        .sidebar-title {
            padding: 16px 20px 0 20px;
            background: white;
            flex-shrink: 0;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .sidebar-header {
            padding: 0 20px 16px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
        }
        
        @media (max-width: 768px) {
            .sidebar-drag-handle {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 16px 0;
                cursor: pointer;
                position: sticky;
                top: 0;
                background: white;
                z-index: 100;
                border-radius: 16px 16px 0 0;
            }
            
            .sidebar-drag-handle::before {
                content: '';
                width: 40px;
                height: 4px;
                background: #dadce0;
                border-radius: 2px;
            }
            
            .sidebar-title {
                padding: 12px 16px 0 16px;
                position: sticky;
                top: 32px;
                z-index: 99;
            }
            
            .sidebar-header {
                padding: 0 16px 12px 16px;
            }
        }
        
        .sort-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .sort-btn {
            flex: 1;
            padding: 6px 12px;
            font-size: 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        @media (max-width: 768px) {
            .sort-btn {
                padding: 10px 8px;
                font-size: 11px;
            }
        }
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sort-btn:hover {
            background: #f5f5f5;
        }
        
        .sort-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .cafe-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .cafe-item {
                padding: 14px 16px;
            }
        }
        
        .cafe-item:hover { background: #f9f9f9; }
        .cafe-item:active { background: #f0f0f0; }
        
        .cafe-header {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .signal-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .signal-green { background: #4CAF50; }
        .signal-yellow { background: #FFC107; }
        .signal-red { background: #F44336; }
        .signal-gray { background: #9E9E9E; }
        
        .cafe-name { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
        .cafe-address { font-size: 12px; color: #666; }
        
        .cafe-indicators {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .indicator {
            font-size: 11px;
            padding: 4px 8px;
            background: #f5f5f5;
            border-radius: 12px;
        }
        
        .custom-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            position: relative;
        }
        
        .marker-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            background: white;
        }
        
        /* 0.0ì  ì¹´í˜ëŠ” ë°°ê²½/í…Œë‘ë¦¬ ì—†ìŒ */
        .marker-icon.no-score {
            background: transparent;
            border: none;
            box-shadow: none;
        }
        
        .marker-icon:hover {
            transform: scale(1.15);
        }
        
        .marker-icon.green { 
            border: 3px solid #4CAF50;
            z-index: 1000 !important;
        }
        .marker-icon.yellow { 
            border: 3px solid #FFC107;
            z-index: 900 !important;
        }
        .marker-icon.red { 
            border: 3px solid #F44336;
            z-index: 800 !important;
        }
        .marker-icon.gray { 
            border: 3px solid #9E9E9E;
            z-index: 700 !important;
        }
        
        .marker-icon.green.active { background: #4CAF50; }
        .marker-icon.yellow.active { background: #FFC107; }
        .marker-icon.red.active { background: #F44336; }
        .marker-icon.gray.active { background: #9E9E9E; }
        
        .marker-icon::before {
            content: 'â˜•';
            font-size: 24px;
            display: block;
        }
        
        .marker-icon.green::before { color: #4CAF50; }
        .marker-icon.yellow::before { color: #FFC107; }
        .marker-icon.red::before { color: #F44336; }
        .marker-icon.gray::before { color: #9E9E9E; }
        
        .marker-icon.active::before {
            color: white;
        }
        
        .marker-score {
            font-size: 11px;
            font-weight: bold;
            margin-top: -3px;
            color: #333;
        }
        
        .marker-icon.active .marker-score {
            color: white;
        }
        
        .marker-name {
            font-size: 11px;
            font-weight: 600;
            color: #333;
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            margin-top: 4px;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .marker-name.hidden {
            display: none;
        }
        
        /* PWA ì„¤ì¹˜ ë°°ë„ˆ */
        #pwaInstallBanner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 16px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            z-index: 9999;
            display: none;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        
        #pwaInstallBanner .banner-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 600px;
            margin: 0 auto;
        }
        
        #pwaInstallBanner .banner-text {
            flex: 1;
        }
        
        #pwaInstallBanner .banner-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        #pwaInstallBanner .banner-desc {
            font-size: 13px;
            opacity: 0.9;
        }
        
        #pwaInstallBanner .banner-buttons {
            display: flex;
            gap: 10px;
            margin-left: 15px;
        }
        
        #pwaInstallBanner button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #pwaInstallBanner .install-btn {
            background: white;
            color: #4CAF50;
        }
        
        #pwaInstallBanner .install-btn:hover {
            transform: scale(1.05);
        }
        
        #pwaInstallBanner .close-btn {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        /* iOS ì„¤ì¹˜ ê°€ì´ë“œ ëª¨ë‹¬ */
        #iosInstallModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        #iosInstallModal .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        #iosInstallModal .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
        }
        
        #iosInstallModal .modal-steps {
            text-align: left;
            margin: 20px 0;
            line-height: 1.8;
            color: #666;
        }
        
        #iosInstallModal .modal-step {
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #iosInstallModal .step-number {
            background: #4CAF50;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        #iosInstallModal .modal-icon {
            font-size: 40px;
            margin: 10px 0;
        }
        
        #iosInstallModal .modal-close {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
        }
        
        @media (max-width: 768px) {
            #pwaInstallBanner {
                padding: 12px 16px;
            }
            
            #pwaInstallBanner .banner-content {
                flex-direction: column;
                gap: 12px;
            }
            
            #pwaInstallBanner .banner-buttons {
                margin-left: 0;
                width: 100%;
            }
            
            #pwaInstallBanner button {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading-screen">
        <img src="/cagong6.png" alt="CoffeeMap">
    </div>

    <!-- êµ¬ê¸€ë§µ ìŠ¤íƒ€ì¼ ê²€ìƒ‰ë°” -->
    <div class="search-container">
        <div class="search-bar">
            <input type="text" id="topSearchInput" placeholder="Coffee" onkeyup="handleSearch(event)">
            <span class="close-btn" onclick="clearSearch()">âœ•</span>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-drag-handle"></div>
        <div class="sidebar-title">
            <div style="font-size:18px;font-weight:600;">Coffee</div>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-header">
                <div id="cafeCount" style="font-size:13px;color:#666;margin-top:4px;">Loading...</div>
                <div class="sort-buttons">
                    <button class="sort-btn active" onclick="sortCafes('score-high')">í‰ì  ë†’ì€ìˆœ</button>
                    <button class="sort-btn" onclick="sortCafes('score-low')">í‰ì  ë‚®ì€ìˆœ</button>
                    <button class="sort-btn" onclick="sortCafes('distance')">ê±°ë¦¬ìˆœ</button>
                </div>
            </div>
            <div id="cafeList"></div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <!-- í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ -->
    <button id="currentLocationBtn" style="position:fixed;bottom:20px;right:20px;width:50px;height:50px;border-radius:50%;background:#fff;border:2px solid #ddd;box-shadow:0 2px 6px rgba(0,0,0,0.3);cursor:pointer;z-index:1000;display:flex;align-items:center;justify-content:center;transition:all 0.2s;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 2v4m0 12v4M2 12h4m12 0h4"/>
        </svg>
    </button>
    
    <!-- PWA ì„¤ì¹˜ ë°°ë„ˆ -->
    <div id="pwaInstallBanner">
        <div class="banner-content">
            <div class="banner-text">
                <div class="banner-title">ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</div>
                <div class="banner-desc">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ê³  ë” ë¹ ë¥´ê²Œ ì´ìš©í•˜ì„¸ìš”</div>
            </div>
            <div class="banner-buttons">
                <button class="install-btn" onclick="handlePWAInstall()">ì„¤ì¹˜</button>
                <button class="close-btn" onclick="closePWABanner()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <!-- iOS ì„¤ì¹˜ ê°€ì´ë“œ ëª¨ë‹¬ -->
    <div id="iosInstallModal" onclick="closeIOSModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">ì•± ì„¤ì¹˜ ë°©ë²• (iPhone)</div>
            <div class="modal-icon">ğŸ“²</div>
            <div class="modal-steps">
                <div class="modal-step">
                    <div class="step-number">1</div>
                    <div>í•˜ë‹¨ì˜ <strong>ê³µìœ </strong> ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</div>
                </div>
                <div class="modal-step">
                    <div class="step-number">2</div>
                    <div><strong>í™ˆ í™”ë©´ì— ì¶”ê°€</strong>ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                </div>
                <div class="modal-step">
                    <div class="step-number">3</div>
                    <div>ìš°ì¸¡ ìƒë‹¨ <strong>ì¶”ê°€</strong>ë¥¼ ëˆ„ë¥´ì„¸ìš”</div>
                </div>
            </div>
            <button class="modal-close" onclick="closeIOSModal()">í™•ì¸</button>
        </div>
    </div>
    
    <style>
        #currentLocationBtn:hover {
            background: #f5f5f5 !important;
        }
        
        @media (max-width: 768px) {
            #currentLocationBtn {
                bottom: 100px;
                right: 15px;
                width: 45px;
                height: 45px;
            }
        }
    </style>

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=1b39ab278b34720c916eff1fe31ea422&libraries=services"></script>
    <script>
        console.log('=== ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ ===');
        
        // API Base URL ì„¤ì •
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://138.2.127.70'
            : '';
        
        let map, allCafes = [], markers = [], activeMarkerIdx = null;
        let currentSort = 'score-high';
        let userLocation = null;
        let userMarker = null;
        
        // ê²€ìƒ‰ ì´ˆê¸°í™”
        function clearSearch() {
            document.getElementById('topSearchInput').value = '';
            handleSearch({ key: 'Enter' });
        }
        
        // êµ¬ê¸€ë§µ ìŠ¤íƒ€ì¼ ë“œë˜ê·¸ í•¸ë“¤
        let startY = 0;
        let currentY = 0;
        let isDragging = false;
        const sidebar = document.getElementById('sidebar');
        const dragHandle = document.querySelector('.sidebar-drag-handle');
        const sidebarTitle = document.querySelector('.sidebar-title');
        
        console.log('sidebar:', sidebar);
        console.log('dragHandle:', dragHandle);
        console.log('sidebarTitle:', sidebarTitle);
        
        if (dragHandle) {
            console.log('ë“œë˜ê·¸ í•¸ë“¤ ì´ë²¤íŠ¸ ë“±ë¡');
            
            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            dragHandle.addEventListener('click', () => {
                console.log('ë“œë˜ê·¸ í•¸ë“¤ í´ë¦­');
                sidebar.classList.toggle('expanded');
                sidebar.classList.toggle('collapsed');
            });
            
            let touchStartTime = 0;
            let touchMoved = false;
            
            dragHandle.addEventListener('touchstart', e => {
                console.log('touchstart');
                startY = e.touches[0].clientY;
                isDragging = true;
                touchStartTime = Date.now();
                touchMoved = false;
                sidebar.style.transition = 'none';
            }, { passive: true });
            
            dragHandle.addEventListener('touchmove', e => {
                if (!isDragging) return;
                console.log('touchmove');
                touchMoved = true;
                currentY = e.touches[0].clientY;
                const deltaY = currentY - startY;
                
                if (deltaY > 0) {
                    const newTransform = Math.min(deltaY, window.innerHeight * 0.8);
                    sidebar.style.transform = `translateY(${newTransform}px)`;
                }
            }, { passive: true });
            
            dragHandle.addEventListener('touchend', e => {
                if (!isDragging) return;
                console.log('touchend');
                isDragging = false;
                sidebar.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                
                const touchDuration = Date.now() - touchStartTime;
                
                // ì§§ì€ íƒ­ (ë“œë˜ê·¸ ì—†ì´ í´ë¦­)
                if (!touchMoved && touchDuration < 300) {
                    console.log('ë“œë˜ê·¸ í•¸ë“¤ íƒ­');
                    sidebar.classList.toggle('expanded');
                    sidebar.classList.toggle('collapsed');
                    sidebar.style.transform = '';
                    return;
                }
                
                const deltaY = currentY - startY;
                if (deltaY > 100) {
                    sidebar.classList.remove('expanded');
                    sidebar.classList.add('collapsed');
                    sidebar.style.transform = '';
                } else {
                    sidebar.classList.add('expanded');
                    sidebar.classList.remove('collapsed');
                    sidebar.style.transform = '';
                }
            }, { passive: true });
        }
        
        // Coffee íƒ€ì´í‹€ í´ë¦­ìœ¼ë¡œ í† ê¸€
        if (sidebarTitle) {
            console.log('íƒ€ì´í‹€ í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡');
            sidebarTitle.addEventListener('click', () => {
                console.log('íƒ€ì´í‹€ í´ë¦­');
                sidebar.classList.toggle('expanded');
                sidebar.classList.toggle('collapsed');
            });
        }

        // Service Worker ê°•ì œ ì—…ë°ì´íŠ¸ ë° ìºì‹œ ì‚­ì œ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(reg => reg.unregister());
            });
        }
        
        // ëª¨ë“  localStorage ìºì‹œ ê°•ì œ ì‚­ì œ
        (function() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('cafe_')) {
                    keys.push(key);
                }
            }
            keys.forEach(key => localStorage.removeItem(key));
            console.log(`ì „ì²´ ìºì‹œ ${keys.length}ê°œ ì‚­ì œ`);
        })();
        
        window.addEventListener('load', function() {
            console.log('í˜ì´ì§€ ë¡œë“œë¨');
            if (typeof kakao !== 'undefined' && kakao.maps) {
                kakao.maps.load(initMap);
            } else {
                console.error('ì¹´ì¹´ì˜¤ ë§µ ë¡œë“œ ì‹¤íŒ¨');
            }
            
            // ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('ì‚¬ìš©ì ìœ„ì¹˜:', userLocation);
                        showUserLocationMarker();
                    },
                    error => console.log('ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ ë˜ëŠ” ì—ëŸ¬:', error)
                );
            }
        });
        
        function clearOldCache() {
            // localStorageì—ì„œ cafe_ ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  í‚¤ ì°¾ê¸°
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('cafe_')) {
                    keys.push(key);
                }
            }
            
            // íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì˜¤ë˜ëœ ê²ƒë¶€í„° ì‚­ì œ
            const items = keys.map(key => {
                try {
                    const item = JSON.parse(localStorage.getItem(key));
                    return { key, timestamp: item.timestamp || 0 };
                } catch {
                    return { key, timestamp: 0 };
                }
            }).sort((a, b) => a.timestamp - b.timestamp);
            
            // ê°€ì¥ ì˜¤ë˜ëœ 30% ì‚­ì œ
            const deleteCount = Math.ceil(items.length * 0.3);
            for (let i = 0; i < deleteCount; i++) {
                localStorage.removeItem(items[i].key);
            }
            console.log(`ì˜¤ë˜ëœ ìºì‹œ ${deleteCount}ê°œ ì‚­ì œ`);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ êµ¬ë²„ì „ ìºì‹œ ì‚­ì œ
        (function() {
            const CACHE_VERSION = 'v20';
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('cafe_') && !key.startsWith(`cafe_${CACHE_VERSION}_`)) {
                    keys.push(key);
                }
            }
            keys.forEach(key => localStorage.removeItem(key));
            if (keys.length > 0) {
                console.log(`êµ¬ë²„ì „ ìºì‹œ ${keys.length}ê°œ ì‚­ì œ`);
            }
        })();
        
        function initMap() {
            console.log('ì§€ë„ ì´ˆê¸°í™”');
            
            map = new kakao.maps.Map(document.getElementById('map'), {
                center: new kakao.maps.LatLng(37.3943, 126.9568),
                level: 5
            });
            
            kakao.maps.event.addListener(map, 'idle', searchCafes);
            searchCafes();
            
            // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸° (2ì´ˆ í›„)
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
            }, 2000);
        }
        
        function searchCafes() {
            console.log('ì¹´í˜ ê²€ìƒ‰ ì‹œì‘');
            const ps = new kakao.maps.services.Places();
            const center = map.getCenter();
            
            ps.keywordSearch('ì¹´í˜', (data, status) => {
                console.log('ê²€ìƒ‰ ê²°ê³¼:', status, data ? data.length : 0);
                if (status === kakao.maps.services.Status.OK) {
                    allCafes = data.map(place => ({
                        name: place.place_name,
                        address: place.address_name,
                        phone: place.phone || '',
                        latitude: parseFloat(place.y),
                        longitude: parseFloat(place.x),
                        workScore: 0  // ì´ˆê¸°ê°’
                    }));
                    renderCafeList(allCafes);
                    displayMarkers(allCafes);
                }
            }, {
                location: new kakao.maps.LatLng(center.getLat(), center.getLng()),
                radius: 5000,
                category_group_code: 'CE7'
            });
        }
        
        function sortAndRenderCafes() {
            // ì‘ì—… ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬
            const sorted = [...allCafes].sort((a, b) => {
                const scoreA = a.detailData ? a.detailData.workScore : 0;
                const scoreB = b.detailData ? b.detailData.workScore : 0;
                return scoreB - scoreA;
            });
            
            const list = document.getElementById('cafeList');
            document.getElementById('cafeCount').textContent = sorted.length + ' cafes';
            
            list.innerHTML = sorted.map((cafe) => {
                const idx = allCafes.indexOf(cafe);
                const data = cafe.detailData;
                const signalColor = data ? data.signalColor : 'gray';
                
                let indicatorsHtml = '<div class="indicator">ë¶„ì„ì¤‘...</div>';
                if (data) {
                    let html = '';
                    if (data.workScore > 0) html += '<div class="indicator">ğŸ’¼ ' + data.workScore + '/10</div>';
                    if (data.outletLevel !== 'ì •ë³´ ì—†ìŒ') html += '<div class="indicator">ğŸ”Œ ' + data.outletLevel + '</div>';
                    if (data.noiseLevel !== 'ì •ë³´ ì—†ìŒ') html += '<div class="indicator">ğŸ”‡ ' + data.noiseLevel + '</div>';
                    if (data.hasWifi) html += '<div class="indicator">ğŸ“¶ WiFi</div>';
                    if (data.blogCount > 0) html += '<div class="indicator">ğŸ“ ' + data.blogCount + '</div>';
                    indicatorsHtml = html || '<div class="indicator">ì •ë³´ ì—†ìŒ</div>';
                }
                
                return `
                    <div class="cafe-item" onclick="showCafeDetail(${idx})">
                        <div class="cafe-header">
                            <div class="signal-dot signal-${signalColor}"></div>
                            <div>
                                <div class="cafe-name">${cafe.name}</div>
                                <div class="cafe-address">${cafe.address}</div>
                            </div>
                        </div>
                        <div class="cafe-indicators">${indicatorsHtml}</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderCafeList(cafes) {
            console.log('ë¦¬ìŠ¤íŠ¸ ë Œë”ë§:', cafes.length);
            const list = document.getElementById('cafeList');
            document.getElementById('cafeCount').textContent = cafes.length + ' cafes';
            
            list.innerHTML = cafes.map((cafe, idx) => {
                const originalIdx = cafe.originalIdx !== undefined ? cafe.originalIdx : idx;
                return `
                    <div class="cafe-item" onclick="showCafeDetail(${originalIdx})">
                        <div class="cafe-header">
                            <div class="signal-dot signal-${cafe.detailData ? cafe.detailData.signalColor : 'gray'}" id="signal-${originalIdx}"></div>
                            <div>
                                <div class="cafe-name">${cafe.name}</div>
                                <div class="cafe-address">${cafe.address}</div>
                            </div>
                        </div>
                        <div class="cafe-indicators" id="indicators-${originalIdx}">
                            ${cafe.detailData ? getIndicatorsHtml(cafe.detailData) : '<div class="indicator">ë¶„ì„ì¤‘...</div>'}
                        </div>
                    </div>
                `;
            }).join('');
            
            // ì²˜ìŒ ë Œë”ë§í•  ë•Œë§Œ loadIndicators í˜¸ì¶œ (ìˆœì°¨ ì²˜ë¦¬)
            if (cafes[0] && cafes[0].originalIdx === undefined) {
                cafes.forEach((cafe, idx) => {
                    cafe.originalIdx = idx;
                    setTimeout(() => loadIndicators(cafe, idx), idx * 100);
                });
            }
        }
        
        function getIndicatorsHtml(data) {
            let html = '';
            if (data.workScore > 0) html += '<div class="indicator">ğŸ’¼ ' + data.workScore + '/10</div>';
            if (data.outletLevel !== 'ì •ë³´ ì—†ìŒ') html += '<div class="indicator">ğŸ”Œ ' + data.outletLevel + '</div>';
            if (data.noiseLevel !== 'ì •ë³´ ì—†ìŒ') html += '<div class="indicator">ğŸ”‡ ' + data.noiseLevel + '</div>';
            if (data.hasWifi) html += '<div class="indicator">ğŸ“¶ WiFi</div>';
            if (data.blogCount > 0) html += '<div class="indicator">ğŸ“ ' + data.blogCount + '</div>';
            return html || '<div class="indicator">ì •ë³´ ì—†ìŒ</div>';
        }
        
        function sortCafes(sortType) {
            currentSort = sortType;
            
            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            let sortedCafes = [...allCafes];
            
            if (sortType === 'score-high') {
                sortedCafes.sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
            } else if (sortType === 'score-low') {
                sortedCafes.sort((a, b) => (a.totalScore || 0) - (b.totalScore || 0));
            } else if (sortType === 'distance') {
                if (!userLocation) {
                    alert('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                    return;
                }
                sortedCafes.sort((a, b) => {
                    const distA = getDistance(userLocation.lat, userLocation.lng, a.latitude, a.longitude);
                    const distB = getDistance(userLocation.lat, userLocation.lng, b.latitude, b.longitude);
                    return distA - distB;
                });
            }
            
            renderCafeList(sortedCafes);
        }
        
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function handleSearch(event) {
            if (event.key === 'Enter' || !event.key) {
                const query = (event.target?.value || document.getElementById('topSearchInput').value).trim();
                if (!query) {
                    // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ í˜„ì¬ ìœ„ì¹˜ë¡œ ë¦¬ì…‹
                    if (userLocation) {
                        map.setCenter(new kakao.maps.LatLng(userLocation.lat, userLocation.lng));
                    }
                    return;
                }
                
                searchLocation(query);
            }
        }
        
        function searchLocation(query) {
            const ps = new kakao.maps.services.Places();
            
            // ì¹´í˜ + ê²€ìƒ‰ì–´ë¡œ ê²€ìƒ‰
            ps.keywordSearch(query + ' ì¹´í˜', (data, status) => {
                if (status === kakao.maps.services.Status.OK && data.length > 0) {
                    // ì²« ë²ˆì§¸ ê²°ê³¼ë¡œ ì´ë™
                    const place = data[0];
                    const moveLatLon = new kakao.maps.LatLng(place.y, place.x);
                    
                    // ì§€ë„ ì´ë™
                    map.setCenter(moveLatLon);
                    map.setLevel(3); // ì¤Œì¸
                    
                    // ì¹´í˜ ê²€ìƒ‰ (ìë™ìœ¼ë¡œ idle ì´ë²¤íŠ¸ ë°œìƒ)
                } else {
                    // ì¹´í˜ ì—†ì´ ì§€ì—­ë§Œ ê²€ìƒ‰
                    ps.keywordSearch(query, (data, status) => {
                        if (status === kakao.maps.services.Status.OK && data.length > 0) {
                            const place = data[0];
                            const moveLatLon = new kakao.maps.LatLng(place.y, place.x);
                            map.setCenter(moveLatLon);
                            map.setLevel(4);
                        } else {
                            alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    });
                }
            });
        }
        
        function showCafeDetail(idx) {
            const cafe = allCafes[idx];
            if (!cafe.detailData) {
                alert('ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì§€ë„ í¬ì»¤ìŠ¤
            map.setCenter(new kakao.maps.LatLng(cafe.latitude, cafe.longitude));
            map.setLevel(3);
            
            // ì´ì „ í™œì„± ë§ˆì»¤ ë¹„í™œì„±í™”
            if (activeMarkerIdx !== null) {
                const prevMarker = document.getElementById('marker-' + activeMarkerIdx);
                if (prevMarker) prevMarker.classList.remove('active');
            }
            
            // í˜„ì¬ ë§ˆì»¤ í™œì„±í™”
            const currentMarker = document.getElementById('marker-' + idx);
            if (currentMarker) currentMarker.classList.add('active');
            activeMarkerIdx = idx;
            
            showModal(cafe, cafe.detailData);
        }
        
        // í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
        document.getElementById('currentLocationBtn').addEventListener('click', () => {
            if (!userLocation) {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            map.setCenter(new kakao.maps.LatLng(userLocation.lat, userLocation.lng));
                            map.setLevel(4);
                            showUserLocationMarker();
                        },
                        () => alert('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.')
                    );
                } else {
                    alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } else {
                map.setCenter(new kakao.maps.LatLng(userLocation.lat, userLocation.lng));
                map.setLevel(4);
            }
        });
        
        function showModal(cafe, data) {
            let html = '<h2 style="margin-bottom:20px;">' + cafe.name + '</h2>';
            
            // ì¹´ê³µ ì§€í‘œ ì¹´ë“œ
            html += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:20px 0;">';
            
            if (data.workScore > 0) {
                html += '<div style="padding:16px;background:#e8f5e9;border-radius:8px;text-align:center;">' +
                    '<div style="font-size:24px;">ğŸ’¼</div>' +
                    '<div style="font-size:20px;font-weight:bold;margin:8px 0;">' + data.workScore + '/10</div>' +
                    '<div style="font-size:12px;color:#666;">ì‘ì—… ì í•©ë„</div></div>';
            }
            
            if (data.outletLevel !== 'ì •ë³´ ì—†ìŒ') {
                html += '<div style="padding:16px;background:#fff3e0;border-radius:8px;text-align:center;">' +
                    '<div style="font-size:24px;">ğŸ”Œ</div>' +
                    '<div style="font-size:14px;font-weight:bold;margin:8px 0;">' + data.outletLevel + '</div>' +
                    '<div style="font-size:12px;color:#666;">ì½˜ì„¼íŠ¸</div></div>';
            }
            
            if (data.noiseLevel !== 'ì •ë³´ ì—†ìŒ') {
                html += '<div style="padding:16px;background:#e3f2fd;border-radius:8px;text-align:center;">' +
                    '<div style="font-size:24px;">ğŸ”‡</div>' +
                    '<div style="font-size:14px;font-weight:bold;margin:8px 0;">' + data.noiseLevel + '</div>' +
                    '<div style="font-size:12px;color:#666;">ì†ŒìŒ ë ˆë²¨</div></div>';
            }
            
            if (data.tableHeight !== 'ì •ë³´ ì—†ìŒ') {
                html += '<div style="padding:16px;background:#f3e5f5;border-radius:8px;text-align:center;">' +
                    '<div style="font-size:24px;">ğŸ“</div>' +
                    '<div style="font-size:14px;font-weight:bold;margin:8px 0;">' + data.tableHeight + '</div>' +
                    '<div style="font-size:12px;color:#666;">í…Œì´ë¸” ë†’ì´</div></div>';
            }
            
            if (data.spaceLevel && data.spaceLevel !== 'ì •ë³´ ì—†ìŒ') {
                html += '<div style="padding:16px;background:#fff9c4;border-radius:8px;text-align:center;">' +
                    '<div style="font-size:24px;">ğŸ“</div>' +
                    '<div style="font-size:14px;font-weight:bold;margin:8px 0;">' + data.spaceLevel + '</div>' +
                    '<div style="font-size:12px;color:#666;">ê³µê°„ê°</div></div>';
            }
            
            html += '</div>';
            
            // ê¸°ë³¸ ì •ë³´
            html += '<div style="margin:20px 0;line-height:1.8;background:#f5f5f5;padding:16px;border-radius:8px;">';
            html += '<div>ğŸ“ ' + cafe.address + '</div>';
            if (cafe.phone) html += '<div>ğŸ“ ' + cafe.phone + '</div>';
            if (data.hasWifi) html += '<div>ğŸ“¶ WiFi ê°€ëŠ¥</div>';
            if (data.hasParking) html += '<div>ğŸ…¿ï¸ ì£¼ì°¨ ê°€ëŠ¥</div>';
            if (data.timeLimit !== 'ì •ë³´ ì—†ìŒ') html += '<div>â° ' + data.timeLimit + '</div>';
            html += '</div>';
            
            // í‚¤ì›Œë“œ ë¶„ì„
            if (data.keywords && Object.keys(data.keywords).length > 0) {
                html += '<div style="margin:20px 0;"><h3 style="font-size:14px;margin-bottom:10px;">ğŸ“Š ë¸”ë¡œê·¸ í‚¤ì›Œë“œ ë¶„ì„</h3>';
                html += '<div style="display:flex;gap:8px;flex-wrap:wrap;">';
                for (let key in data.keywords) {
                    if (data.keywords[key] > 0) {
                        html += '<span style="padding:6px 12px;background:#e0e0e0;border-radius:16px;font-size:12px;">' + 
                            key + ' (' + data.keywords[key] + ')</span>';
                    }
                }
                html += '</div></div>';
            }
            
            // ì¹´í˜ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ (Object Storage)
            if (data.images && data.images.length > 0) {
                html += '<div style="margin-top:20px;"><h3 style="font-size:14px;margin-bottom:10px;">ğŸ“· ì¹´í˜ ì‚¬ì§„ (' + data.images.length + ')</h3>';
                html += '<div style="display:flex;gap:8px;overflow-x:auto;padding:4px 0;">';
                data.images.forEach(function(imgUrl, idx) {
                    const blogItem = data.blogItems && data.blogItems[idx] ? data.blogItems[idx] : null;
                    const blogUrl = blogItem ? blogItem.url : '#';
                    const blogTitle = blogItem ? blogItem.title.replace(/<[^>]*>/g, '').substring(0, 15) + '...' : 'ë¸”ë¡œê·¸';
                    html += '<div style="position:relative;flex-shrink:0;">' +
                        '<a href="' + blogUrl + '" target="_blank">' +
                        '<img src="' + imgUrl + '" style="height:120px;border-radius:8px;cursor:pointer;object-fit:cover;display:block;">' +
                        '</a>' +
                        '<a href="' + blogUrl + '" target="_blank" style="position:absolute;bottom:4px;right:4px;font-size:9px;background:rgba(0,0,0,0.7);color:#fff;padding:2px 5px;border-radius:3px;text-decoration:none;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">ğŸ“ ' + blogTitle + '</a>' +
                        '</div>';
                });
                html += '</div>';
                html += '<div style="font-size:10px;color:#999;margin-top:8px;">ì´ë¯¸ì§€ í´ë¦­ ì‹œ ì›ë³¸ ë¸”ë¡œê·¸ë¡œ ì´ë™ | <a href="mailto:eungyo0965@gmail.com?subject=ì¹´ê³µë§µ ì´ë¯¸ì§€ ì‹ ê³ /ì‚­ì œ ìš”ì²­" style="color:#999;text-decoration:underline;">ì‹ ê³ /ì‚­ì œ ìš”ì²­</a></div>';
                html += '</div>';
            }
            
            // ë¸”ë¡œê·¸ ë¦¬ë·°
            if (data.blogItems && data.blogItems.length > 0) {
                html += '<div style="margin-top:20px;"><h3 style="font-size:14px;margin-bottom:10px;">ğŸ“ ë¸”ë¡œê·¸ ë¦¬ë·° (' + data.blogItems.length + ')</h3>';
                data.blogItems.forEach(function(item, i) {
                    html += '<a href="' + item.url + '" target="_blank" style="display:block;padding:12px;margin:8px 0;background:#f9f9f9;border-radius:8px;text-decoration:none;color:#333;transition:background 0.2s;border-left:3px solid #4CAF50;" onmouseover="this.style.background=\'#f0f0f0\'" onmouseout="this.style.background=\'#f9f9f9\'">' +
                        '<div style="font-weight:600;font-size:13px;margin-bottom:6px;color:#222;">' + item.title + '</div>' +
                        '<div style="font-size:12px;color:#666;line-height:1.4;">' + item.description + '</div>' +
                        '</a>';
                });
                html += '</div>';
            } else if (data.blogUrls && data.blogUrls.length > 0) {
                // í•˜ìœ„ í˜¸í™˜ì„±
                html += '<div style="margin-top:20px;"><h3 style="font-size:14px;margin-bottom:10px;">ğŸ“ ë¸”ë¡œê·¸ ë¦¬ë·°</h3>';
                data.blogUrls.forEach(function(url, i) {
                    html += '<a href="' + url + '" target="_blank" style="display:block;padding:12px;margin:8px 0;background:#f0f0f0;border-radius:6px;text-decoration:none;color:#333;transition:background 0.2s;" onmouseover="this.style.background=\'#e0e0e0\'" onmouseout="this.style.background=\'#f0f0f0\'">ğŸ“ ë¸”ë¡œê·¸ ë¦¬ë·° ' + (i + 1) + '</a>';
                });
                html += '</div>';
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px;';
            modal.innerHTML = '<div style="background:white;max-width:600px;max-height:80vh;overflow-y:auto;border-radius:12px;padding:30px;position:relative;width:100%;">' +
                '<span style="position:absolute;top:15px;right:20px;font-size:32px;cursor:pointer;color:#999;line-height:1;" onclick="this.parentElement.parentElement.remove()">Ã—</span>' +
                html + '</div>';
            modal.onclick = function(e) { 
                if (e.target === modal) modal.remove(); 
            };
            document.body.appendChild(modal);
        }
        
        function displayMarkers(cafes) {
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            markers.forEach(m => m.setMap(null));
            markers = [];
            
            cafes.forEach((cafe, idx) => {
                const content = document.createElement('div');
                content.className = 'custom-marker';
                content.innerHTML = '<div class="marker-icon gray" id="marker-' + idx + '">' +
                    '<div class="marker-score">-</div>' +
                    '</div>' +
                    '<div class="marker-name hidden" id="marker-name-' + idx + '">' + cafe.name + '</div>';
                
                const marker = new kakao.maps.CustomOverlay({
                    position: new kakao.maps.LatLng(cafe.latitude, cafe.longitude),
                    content: content,
                    yAnchor: 0.5,
                    zIndex: 700
                });
                
                marker.setMap(map);
                markers.push(marker);
                
                content.onclick = function() {
                    // ì´ì „ í™œì„± ë§ˆì»¤ ë¹„í™œì„±í™”
                    if (activeMarkerIdx !== null) {
                        const prevMarker = document.getElementById('marker-' + activeMarkerIdx);
                        if (prevMarker) prevMarker.classList.remove('active');
                    }
                    
                    // í˜„ì¬ ë§ˆì»¤ í™œì„±í™”
                    const currentMarker = document.getElementById('marker-' + idx);
                    if (currentMarker) currentMarker.classList.add('active');
                    activeMarkerIdx = idx;
                    
                    if (cafe.detailData) {
                        showModal(cafe, cafe.detailData);
                    } else {
                        alert('ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                };
            });
            
            // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ë‹¤ì‹œ í‘œì‹œ
            showUserLocationMarker();
        }
        
        function showUserLocationMarker() {
            if (!userLocation) return;
            
            // ê¸°ì¡´ ì‚¬ìš©ì ë§ˆì»¤ ì œê±°
            if (userMarker) {
                userMarker.setMap(null);
            }
            
            // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ìƒì„±
            const userContent = document.createElement('div');
            userContent.style.cssText = 'width: 20px; height: 20px; background: #4285F4; border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 1000;';
            
            userMarker = new kakao.maps.CustomOverlay({
                position: new kakao.maps.LatLng(userLocation.lat, userLocation.lng),
                content: userContent,
                zIndex: 1000
            });
            
            userMarker.setMap(map);
        }
        
        function updateMarker(idx, data) {
            const markerIcon = document.getElementById('marker-' + idx);
            if (markerIcon && data) {
                const oldColor = markerIcon.className.split(' ')[1];
                const newColor = data.signalColor || 'gray';
                
                // 0.0ì ì´ë©´ no-score í´ë˜ìŠ¤ ì¶”ê°€
                if (data.totalScore === 0) {
                    markerIcon.className = 'marker-icon no-score';
                } else {
                    markerIcon.className = 'marker-icon ' + newColor;
                }
                
                // z-index ì—…ë°ì´íŠ¸
                const zIndexMap = { green: 1000, yellow: 900, red: 800, gray: 700 };
                if (markers[idx]) {
                    markers[idx].setZIndex(zIndexMap[newColor] || 700);
                }
                
                const scoreEl = markerIcon.querySelector('.marker-score');
                if (scoreEl && data.totalScore !== undefined) {
                    // 0.0ì ì´ë©´ ì ìˆ˜ ìˆ¨ê¸°ê¸°
                    if (data.totalScore === 0) {
                        scoreEl.style.display = 'none';
                    } else {
                        scoreEl.textContent = data.totalScore.toFixed(1);
                        scoreEl.style.display = 'block';
                    }
                }
                
                // í‰ì ì´ ìˆìœ¼ë©´ ì¹´í˜ ì´ë¦„ í‘œì‹œ
                const nameEl = document.getElementById('marker-name-' + idx);
                if (nameEl && data.totalScore > 0) {
                    nameEl.classList.remove('hidden');
                }
            }
        }
        
        async function loadIndicators(cafe, idx, retryCount = 0) {
            try {
                // localStorage ìºì‹œ í™•ì¸ (ë²„ì „ í¬í•¨)
                const CACHE_VERSION = 'v20';  // OCI ì´ë¯¸ì§€ URL ì ìš©
                const cacheKey = `cafe_${CACHE_VERSION}_${cafe.name}_${cafe.address}`;
                const cached = localStorage.getItem(cacheKey);
                
                let data;
                if (cached) {
                    const cachedData = JSON.parse(cached);
                    // ìºì‹œê°€ 24ì‹œê°„ ì´ë‚´ë©´ ì‚¬ìš©
                    if (Date.now() - cachedData.timestamp < 24 * 60 * 60 * 1000) {
                        console.log('ìºì‹œ ì‚¬ìš©:', cafe.name);
                        data = cachedData.data;
                    }
                }
                
                // ìºì‹œê°€ ì—†ê±°ë‚˜ ë§Œë£Œë˜ë©´ API í˜¸ì¶œ
                if (!data) {
                    console.log('API í˜¸ì¶œ:', cafe.name);
                    const response = await fetch(`${API_BASE_URL}/api/blog-search`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: cafe.name, address: cafe.address })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    data = await response.json();
                    
                    // localStorageì— ìºì‹œ ì €ì¥
                    try {
                        localStorage.setItem(cacheKey, JSON.stringify({
                            data: data,
                            timestamp: Date.now()
                        }));
                    } catch (e) {
                        // localStorage ìš©ëŸ‰ ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ìºì‹œ ì‚­ì œ
                        if (e.name === 'QuotaExceededError') {
                            clearOldCache();
                            localStorage.setItem(cacheKey, JSON.stringify({
                                data: data,
                                timestamp: Date.now()
                            }));
                        }
                    }
                }
                
                // ì¹´í˜ ê°ì²´ì— ë°ì´í„° ì €ì¥
                allCafes[idx].detailData = data;
                allCafes[idx].totalScore = data.totalScore || 0;
                
                // ë§ˆì»¤ ì—…ë°ì´íŠ¸ (DOMì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ì•½ê°„ ëŒ€ê¸°)
                setTimeout(() => updateMarker(idx, data), 100);
                
                const signalDot = document.getElementById('signal-' + idx);
                if (signalDot) {
                    signalDot.className = 'signal-dot signal-' + (data.signalColor || 'gray');
                }
                
                const indicators = document.getElementById('indicators-' + idx);
                if (indicators) {
                    let html = '';
                    if (data.workScore > 0) html += '<div class="indicator">ğŸ’¼ ' + data.workScore + '/10</div>';
                    if (data.outletLevel !== 'ì •ë³´ ì—†ìŒ') html += '<div class="indicator">ğŸ”Œ ' + data.outletLevel + '</div>';
                    if (data.noiseLevel !== 'ì •ë³´ ì—†ìŒ') html += '<div class="indicator">ğŸ”‡ ' + data.noiseLevel + '</div>';
                    if (data.hasWifi) html += '<div class="indicator">ğŸ“¶ WiFi</div>';
                    if (data.blogCount > 0) html += '<div class="indicator">ğŸ“ ' + data.blogCount + '</div>';
                    
                    indicators.innerHTML = html || '<div class="indicator">ì •ë³´ ì—†ìŒ</div>';
                }
                
                // ëª¨ë“  ì¹´í˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ í™•ì¸ í›„ ì •ë ¬
                const loadedCount = allCafes.filter(c => c.detailData).length;
                if (loadedCount === allCafes.length) {
                    sortAndRenderCafes();
                }
            } catch (err) {
                console.log('ì§€í‘œ ë¡œë“œ ì‹¤íŒ¨:', cafe.name, err);
                
                // ì¬ì‹œë„ ë¡œì§ (ìµœëŒ€ 3ë²ˆ)
                if (retryCount < 3) {
                    console.log(`ì¬ì‹œë„ ${retryCount + 1}/3:`, cafe.name);
                    setTimeout(() => loadIndicators(cafe, idx, retryCount + 1), 2000 * (retryCount + 1));
                }
            }
        }
        
        function sortAndRenderCafes() {
            // ì‘ì—… ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬
            const sorted = [...allCafes].sort((a, b) => {
                const scoreA = a.detailData ? a.detailData.workScore : 0;
                const scoreB = b.detailData ? b.detailData.workScore : 0;
                return scoreB - scoreA;
            });
            
            const list = document.getElementById('cafeList');
            
            list.innerHTML = sorted.map((cafe) => {
                const idx = allCafes.indexOf(cafe);
                const data = cafe.detailData;
                const signalColor = data ? data.signalColor : 'gray';
                
                let indicatorsHtml = '';
                if (data) {
                    if (data.workScore > 0) indicatorsHtml += '<div class="indicator">ğŸ’¼ ' + data.workScore + '/10</div>';
                    if (data.outletLevel && data.outletLevel !== 'ì •ë³´ ì—†ìŒ') indicatorsHtml += '<div class="indicator">ğŸ”Œ ' + data.outletLevel + '</div>';
                    if (data.noiseLevel && data.noiseLevel !== 'ì •ë³´ ì—†ìŒ') indicatorsHtml += '<div class="indicator">ğŸ”‡ ' + data.noiseLevel + '</div>';
                    if (data.spaceLevel && data.spaceLevel !== 'ì •ë³´ ì—†ìŒ') indicatorsHtml += '<div class="indicator">ğŸ“ ' + data.spaceLevel + '</div>';
                    if (data.hasWifi) indicatorsHtml += '<div class="indicator">ğŸ“¶ WiFi</div>';
                    if (data.blogCount > 0) indicatorsHtml += '<div class="indicator">ğŸ“ ' + data.blogCount + '</div>';
                    if (!indicatorsHtml) indicatorsHtml = '<div class="indicator">ì •ë³´ ì—†ìŒ</div>';
                }
                
                return '<div class="cafe-item" onclick="showCafeDetail(' + idx + ')">' +
                    '<div class="cafe-header">' +
                    '<div class="signal-dot signal-' + signalColor + '"></div>' +
                    '<div>' +
                    '<div class="cafe-name">' + cafe.name + '</div>' +
                    '<div class="cafe-address">' + cafe.address + '</div>' +
                    '</div></div>' +
                    '<div class="cafe-indicators">' + indicatorsHtml + '</div>' +
                    '</div>';
            }).join('');
        }
        
        // PWA ì„¤ì¹˜ ê´€ë ¨ ì½”ë“œ
        let deferredPrompt;
        const pwaInstallBanner = document.getElementById('pwaInstallBanner');
        const iosInstallModal = document.getElementById('iosInstallModal');
        
        // ì´ë¯¸ ì„¤ì¹˜ë˜ì—ˆê±°ë‚˜ ë°°ë„ˆë¥¼ ë‹«ì€ ê²½ìš° ì²´í¬
        const isPWAInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true;
        const bannerDismissed = localStorage.getItem('pwaBannerDismissed');
        
        // BeforeInstallPrompt ì´ë²¤íŠ¸ ìºì¹˜ (Android)
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // ë°°ë„ˆë¥¼ ë‹«ì§€ ì•Šì•˜ê³  ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìœ¼ë©´ 3ì´ˆ í›„ ë°°ë„ˆ í‘œì‹œ
            if (!isPWAInstalled && !bannerDismissed) {
                setTimeout(() => {
                    pwaInstallBanner.style.display = 'block';
                }, 3000);
            }
        });
        
        // iOS ê°ì§€ ë° ë°°ë„ˆ í‘œì‹œ
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS && !isPWAInstalled && !bannerDismissed) {
            setTimeout(() => {
                pwaInstallBanner.style.display = 'block';
            }, 3000);
        }
        
        // ì„¤ì¹˜ ë²„íŠ¼ í´ë¦­
        function handlePWAInstall() {
            if (isIOS) {
                // iOSëŠ” ê°€ì´ë“œ ëª¨ë‹¬ í‘œì‹œ
                iosInstallModal.style.display = 'flex';
                pwaInstallBanner.style.display = 'none';
            } else if (deferredPrompt) {
                // AndroidëŠ” ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA ì„¤ì¹˜ ì™„ë£Œ');
                    }
                    deferredPrompt = null;
                    pwaInstallBanner.style.display = 'none';
                });
            }
        }
        
        // ë°°ë„ˆ ë‹«ê¸°
        function closePWABanner() {
            pwaInstallBanner.style.display = 'none';
            // localStorage ì €ì¥ ì œê±° - ë‹¤ìŒì—ë„ ë°°ë„ˆ í‘œì‹œ
        }
        
        // iOS ëª¨ë‹¬ ë‹«ê¸°
        function closeIOSModal() {
            iosInstallModal.style.display = 'none';
        }
        
        // ì„¤ì¹˜ ì™„ë£Œ ê°ì§€
        window.addEventListener('appinstalled', () => {
            console.log('PWA ì„¤ì¹˜ ì™„ë£Œ');
            pwaInstallBanner.style.display = 'none';
            // ì„¤ì¹˜ ì™„ë£Œ ì‹œì—ë§Œ localStorage ì €ì¥
            localStorage.setItem('pwaBannerDismissed', 'true');
        });
    </script>
</body>
</html>
